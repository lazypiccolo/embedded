#include<stc12.h>
// 32M Crystal Oscillator

__code unsigned char lcd1602[128][7] = {
        //00h-0fh
        {0,    0,    0,    0,    0,    0,    0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        //10h-1fh
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        {0},
        //' '=20h
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        //‘!’=21h
        {0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x04},
        //‘“‘=22h
        {0x0a, 0x0a, 0x0a, 0x00, 0x00, 0x00, 0x00},
        //'#’=23h
        {0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a},
        //‘$’=24h
        {0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04},
        //‘%’=25h
        {0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03},
        //'&'=26h
        {0x0c, 0x12, 0x14, 0x08, 0x15, 0x12, 0x0d},
        //'''=27h
        {0x18, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00},
        //'('=28h
        {0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02},
        //')'=29h
        {0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08},
        //'*'=2ah
        {0x00, 0x04, 0x15, 0x0e, 0x15, 0x04, 0x00},
        //'+'=2bh
        {0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00},
        //','=2ch
        {0x00, 0x00, 0x00, 0x00, 0x0c, 0x04, 0x08},
        //'-'=2dh
        {0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00},
        //'.'=2eh
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c},
        //'/'=2fh
        {0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x00},
        //‘0’=30h
        {0x0e, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0e},
        //‘1’=31h
        {0x04, 0x0c, 0x04, 0x04, 0x04, 0x04, 0x0e},
        //‘2’=32h
        {0x0e, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1f},
        //‘3’=33h
        {0x1f, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0e},
        //‘4’=34h
        {0x02, 0x06, 0x0a, 0x12, 0x1f, 0x02, 0x02},
        //‘5’=35h
        {0x1f, 0x10, 0x1e, 0x01, 0x01, 0x11, 0x0e},
        //‘6’=36h
        {0x06, 0x08, 0x10, 0x1e, 0x11, 0x11, 0x0e},
        //‘7’=37h
        {0x1f, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08},
        //‘8’=38h
        {0x0e, 0x11, 0x11, 0x0e, 0x11, 0x11, 0x0e},
        //‘9’=39h
        {0x0e, 0x11, 0x11, 0x0f, 0x01, 0x02, 0x0c},
        //':'=3ah
        {0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x0c, 0x00},
        //';'=3bh
        {0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08},
        //'<'=3ch
        {0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02},
        //'='=3dh
        {0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00},
        //'>'=3eh
        {0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08},
        //'?'=3fh
        {0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04},
        //'@'=40h
        {0x0e, 0x11, 0x01, 0x0d, 0x15, 0x15, 0x0e},
        //'A'=41h
        {0x0e, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11},
        //'B'=42h
        {0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e},
        //'C'=43h
        {0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e},
        //'D'=44h
        {0x1c, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1c},
        //'E'=45h
        {0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x1f},
        //'F'=46h
        {0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x10},
        //'G'=47h
        {0x0e, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0f},
        //'H'=48h
        {0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11},
        //'I'=49h
        {0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e},
        //'J'=4ah
        {0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c},
        //'K'=4bh
        {0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11},
        //'L'=4ch
        {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f},
        //'M'=4dh
        {0x11, 0x1b, 0x15, 0x15, 0x11, 0x11, 0x11},
        //'N'=4eh
        {0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11},
        //'O'=4fh
        {0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e},
        //'P'=50h
        {0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10},
        //'Q'=51h
        {0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d},
        //'R'=52h
        {0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11},
        //'S'=53h
        {0x0f, 0x10, 0x10, 0x0e, 0x01, 0x01, 0x1e},
        //'T'=54h
        {0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04},
        //'U'=55h
        {0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e},
        //'V'=56h
        {0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04},
        //'W'=57h
        {0x11, 0x11, 0x11, 0x15, 0x15, 0x15, 0x0a},
        //'X'=58h
        {0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11},
        //'Y'=59h
        {0x11, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04},
        //'Z'=5ah
        {0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f},
        //'['=5bh
        {0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e},
        //'\'=5ch
        {0x00, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00},
        //']'=5dh
        {0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e},
        //'^'=5eh
        {0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00},
        //'_'=5fh
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f},
        //'`'=60h
        {0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00},
        //'a'=61h
        {0x00, 0x00, 0x0e, 0x01, 0x0f, 0x11, 0x0f},
        //'b'=62h
        {0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x1e},
        //'c'=63h
        {0x00, 0x00, 0x0e, 0x10, 0x10, 0x11, 0x0e},
        //'d'=64h
        {0x01, 0x01, 0x0d, 0x13, 0x11, 0x11, 0x0f},
        //'e'=65h
        {0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0e},
        //'f'=66h
        {0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08},
        //'g'=67h
        {0x00, 0x0f, 0x11, 0x11, 0x0f, 0x01, 0x0e},
        //'h'=68h
        {0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x11},
        //'i'=69h
        {0x04, 0x00, 0x0c, 0x04, 0x04, 0x04, 0x0e},
        //'j'=6ah
        {0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0c},
        //'k'=6bh
        {0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12},
        //'l'=6ch
        {0x0c, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e},
        //'m'=6dh
        {0x00, 0x00, 0x1a, 0x15, 0x15, 0x11, 0x11},
        //'n'=6eh
        {0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11},
        //'o'=6fh
        {0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e},
        //'p'=70h
        {0x00, 0x00, 0x1e, 0x11, 0x1e, 0x10, 0x10},
        //'q'=71h
        {0x00, 0x00, 0x0d, 0x13, 0x0f, 0x01, 0x01},
        //'r'=72h
        {0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10},
        //'s'=73h
        {0x00, 0x00, 0x0e, 0x10, 0x0e, 0x01, 0x1e},
        //'t'=74h
        {0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06},
        //'u'=75h
        {0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d},
        //'v'=76h
        {0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04},
        //'w'=77h
        {0x00, 0x00, 0x11, 0x11, 0x11, 0x15, 0x0a},
        //'x'=78h
        {0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11},
        //'y'=79h
        {0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x0e},
        //'z'=7ah
        {0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f},
        //'{'=7bh
        {0x02, 0x04, 0x04, 0x08, 0x04, 0x04, 0x02},
        //'|'=7ch
        {0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04},
        //'}'=7dh
        {0x08, 0x04, 0x04, 0x02, 0x04, 0x04, 0x08},
        //'~'=7eh
        {0x00, 0x00, 0x08, 0x15, 0x02, 0x00, 0x00},
};


#define WS2812PIN P2_2
#define WRITE1 WS2812PIN=1;WS2812PIN=1;WS2812PIN=1;WS2812PIN=1;WS2812PIN=1;WS2812PIN=1;WS2812PIN=0;WS2812PIN=0;WS2812PIN=0;WS2812PIN=0
#define WRITE0 WS2812PIN=1;WS2812PIN=1;WS2812PIN=1;WS2812PIN=0;WS2812PIN=0;WS2812PIN=0;WS2812PIN=0;WS2812PIN=0;WS2812PIN=0;WS2812PIN=0

inline void write_frame(unsigned char r, unsigned char g, unsigned b) {
    WS2812PIN = 0;
    if (g & 0x80) { WRITE1; } else { WRITE0; }
    if (g & 0x40) { WRITE1; } else { WRITE0; }
    if (g & 0x20) { WRITE1; } else { WRITE0; }
    if (g & 0x10) { WRITE1; } else { WRITE0; }
    if (g & 0x08) { WRITE1; } else { WRITE0; }
    if (g & 0x04) { WRITE1; } else { WRITE0; }
    if (g & 0x02) { WRITE1; } else { WRITE0; }
    if (g & 0x01) { WRITE1; } else { WRITE0; }

    if (r & 0x80) { WRITE1; } else { WRITE0; }
    if (r & 0x40) { WRITE1; } else { WRITE0; }
    if (r & 0x20) { WRITE1; } else { WRITE0; }
    if (r & 0x10) { WRITE1; } else { WRITE0; }
    if (r & 0x08) { WRITE1; } else { WRITE0; }
    if (r & 0x04) { WRITE1; } else { WRITE0; }
    if (r & 0x02) { WRITE1; } else { WRITE0; }
    if (r & 0x01) { WRITE1; } else { WRITE0; }

    if (b & 0x80) { WRITE1; } else { WRITE0; }
    if (b & 0x40) { WRITE1; } else { WRITE0; }
    if (b & 0x20) { WRITE1; } else { WRITE0; }
    if (b & 0x10) { WRITE1; } else { WRITE0; }
    if (b & 0x08) { WRITE1; } else { WRITE0; }
    if (b & 0x04) { WRITE1; } else { WRITE0; }
    if (b & 0x02) { WRITE1; } else { WRITE0; }
    if (b & 0x01) { WRITE1; } else { WRITE0; }

}

void delay(int n) {
    while (n--) {
        for (int i = 0; i < 1000; i++);
    }
}

inline unsigned char reset() {
    WS2812PIN = 0;
    delay(3);

}

__xdata unsigned char colors[64][3] = {
        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
        {0x01, 0x00, 0x01},
        {0x01, 0x01, 0x00},

        {0x01, 0x00, 0x00},
        {0x00, 0x01, 0x00},
        {0x00, 0x00, 0x01},
        {0x00, 0x01, 0x01},
};

typedef struct {
    unsigned char red;
    unsigned char green;
    unsigned char blue;
} color;
typedef struct {
    color *foreground;
    color *background;
    unsigned int scroll_interval;
    char is_repeat;
} display_config;

void prepare_char_buffer(unsigned char c, unsigned char rr, unsigned char gg, unsigned char bb) {
    unsigned char const *const color = lcd1602[c];
    unsigned char bgr = 0, bgg = 0, bgb = 0;
    for (unsigned char i = 0; i < 7; i++) {
        unsigned char coding = color[i];
        for (unsigned char j = 0; j < 8; j++) {
            unsigned char index = (i << 3) + j;
            unsigned char foreground = 0;
            if (i & 1) {
                if (coding & (0x80 >> j)) {
                    foreground = 1;
                }
            } else {
                if (coding & (0x01 << j)) {
                    foreground = 1;
                }
            }
            if (foreground) {
                colors[index][0] = rr;
                colors[index][1] = gg;
                colors[index][2] = bb;
            } else {
                colors[index][0] = bgr;
                colors[index][1] = bgg;
                colors[index][2] = bgb;
            }
        }
    }
    for (unsigned char j = 0; j < 8; j++) {
        colors[56 + j][0] = bgr;
        colors[56 + j][1] = bgg;
        colors[56 + j][2] = bgb;
    }

}

void show_buffer() {
    reset();
    for (char i = 0; i < 64; i++) {
        unsigned char r = colors[i][0];
        unsigned char g = colors[i][1];
        unsigned char b = colors[i][2];
        write_frame(r, g, b);
    }
}

void write_char(unsigned char c, unsigned char rr, unsigned char gg, unsigned char bb) {
    prepare_char_buffer(c, rr, gg, bb);
    show_buffer();
}

#define CHAR_WIDTH 6
#define CHAR_HEIGHT 7
#define DISPLAY_WIDTH 8
#define DISPLAY_HEIGHT 8

void prepare_scroll_char_buffer(char message[], unsigned char len, int position, display_config *config) {
    unsigned char quotient = position / CHAR_WIDTH;
    unsigned char remainder = position % CHAR_WIDTH;
    char char1 = message[quotient];
    char char2 = message[(quotient + 1) % len];
    char char3 = message[(quotient + 2) % len];

    color *foreground_color = config->foreground;
    color *background_color = config->background;
    for (unsigned char i = 0; i < CHAR_HEIGHT; i++) {
        for (unsigned char j = 0; j < DISPLAY_WIDTH; j++) {
            char flag;
            unsigned char code1 = lcd1602[char1][i];
            unsigned char code2 = lcd1602[char2][i];
            unsigned char code3 = lcd1602[char3][i];
            // Display 3 characters at most, otherwise, the code need be modified.
            // Character encoding at most 8 width, otherwise, the code need be modified, the lcd1602 coding as well.
            if (j <= CHAR_WIDTH - 1 - remainder) {
                flag = code1 & (0x01 << (CHAR_WIDTH - 1 - remainder - j));
            } else if (j <= CHAR_WIDTH * 2 - 1 - remainder) {
                flag = code2 & (0x01 << (CHAR_WIDTH * 2 - 1 - remainder - j));
            } else {
                flag = code3 & (0x01 << (CHAR_WIDTH * 3 - remainder - j));
            }

            unsigned char index;
            if (i & 1) {
                index = i * DISPLAY_WIDTH + j;
            } else {
                index = i * DISPLAY_WIDTH + DISPLAY_WIDTH - 1 - j;
            }
            if (flag) {
                colors[index][0] = foreground_color->red;
                colors[index][1] = foreground_color->green;
                colors[index][2] = foreground_color->blue;
            } else {
                colors[index][0] = background_color->red;
                colors[index][1] = background_color->green;
                colors[index][2] = background_color->blue;
            }
        }
    }
    for (unsigned char i = CHAR_HEIGHT; i < DISPLAY_HEIGHT; i++) {
        for (unsigned char j = 0; j < 8; j++) {
            unsigned int index = i * DISPLAY_WIDTH + j;
            colors[index][0] = background_color->red;
            colors[index][1] = background_color->green;
            colors[index][2] = background_color->blue;
        }
    }
}

void scroll_message(char message[], unsigned char len, display_config *config) {
    int scroll_interval = config->scroll_interval;
    for (int i = 0; i < ((int) len) * CHAR_WIDTH; i++) {
        prepare_scroll_char_buffer(message, len, i, config);
        show_buffer();
        delay(scroll_interval);
    }
}

// long message data should be placed in the code area(start with __code modifier), or ram could not hold.
__code unsigned char message[97] = " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~";

int main() {
    unsigned char c = 32;
    display_config config;
    color foreground = {5, 5, 0};
    color background = {0, 0, 1};
    config.foreground = &foreground;
    config.background = &background;
    config.scroll_interval = 500;
    while (1) {
        scroll_message(message, 96, &config);
    }
    while (1) {
        for (unsigned char i = 0; i < 14; i++) {
            delay(1300);
            write_char(message[i], 5, 5, 0);
            c++;
            if (c == 128) { c = 32; }
        }
    }
}
